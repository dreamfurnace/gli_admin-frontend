<!-- /admin-frontend/src/views/settlement/AdjustmentTab.vue -->
<template>
    <div class="p-4 space-y-8 h-full overflow-y-auto">
        <h1 class="text-xl font-bold">{{ props.selectedMonth }} Ï†ïÏÇ∞ Ï§ÄÎπÑ</h1>
        <!-- 1. ÏÇ¨Ï†Ñ Ï†ïÎ≥¥ ÌôïÏù∏ -->
        <section>
            <h2 class="text-lg font-bold mb-2">1. ÏÇ¨Ï†Ñ Ï†ïÎ≥¥ ÌôïÏù∏</h2>
            <div class="ml-6 overflow-x-auto">
                <table
                    class="min-w-[600px] w-full text-m border border-slate-600 rounded-lg shadow bg-white dark:bg-slate-800"
                >
                    <thead class="bg-slate-200 dark:bg-orange-900">
                        <tr>
                            <th class="px-3 py-2 border-r border-slate-600">Í≤ÄÏÇ¨ ÎåÄÏÉÅ</th>
                            <th class="px-3 py-2 border-r border-slate-600">Ìï≠Î™©</th>
                            <th class="px-3 py-2 border-r border-slate-600">Í≤ÄÏÇ¨ ÎåÄÏÉÅ Í±¥</th>
                            <th class="px-3 py-2 border-r border-slate-600">Ï†ïÏÉÅ Í±¥Ïàò</th>
                            <th class="px-3 py-2 border-r border-slate-600">Ïò§Î•ò Í±¥Ïàò</th>
                            <th class="px-3 py-2 text-center">Í≤∞Í≥º</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(item, idx) in adjustmentStore.precheckList" :key="item.label">
                            <td
                                v-if="idx === 0 || idx === 4"
                                :rowspan="idx === 0 ? 4 : 3"
                                class="px-3 py-1 border-b border-r border-slate-600 text-center"
                            >
                                {{ item.target }}
                            </td>
                            <td
                                class="px-3 py-1 border-r border-slate-600"
                                :class="{ 'border-b border-slate-600': idx === 3 }"
                            >
                                {{ item.label }}
                            </td>
                            <td
                                class="px-3 py-1 border-r border-slate-600 text-right"
                                :class="{ 'border-b border-slate-600': idx === 3 }"
                            >
                                {{ item.totalCount }}
                            </td>
                            <td
                                class="px-3 py-1 border-r border-slate-600 text-right"
                                :class="{ 'border-b border-slate-600': idx === 3 }"
                            >
                                {{ item.normalCount }}
                            </td>
                            <td
                                class="px-3 py-1 border-r border-slate-600 text-right"
                                :class="{
                                    'border-b border-slate-600': idx === 3,
                                    'text-red-600': item.errorCount > 0,
                                }"
                            >
                                {{ item.errorCount }}
                            </td>
                            <td
                                class="px-3 py-1 text-center"
                                :class="{ 'border-b border-slate-600': idx === 3 }"
                            >
                                <span v-if="item.errorCount === 0" class="text-green-600">‚úÖ</span>
                                <button
                                    v-else
                                    @click="openErrorModal(item.errorModalTitle, item.errorDetail)"
                                    class="inline-block bg-red-500 hover:bg-red-600 text-white rounded-full px-3 py-1 text-xs font-bold transition-colors"
                                >
                                    Ïò§Î•ò [ÏûêÏÑ∏Ìûà Î≥¥Í∏∞]
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- 2. Ï†ïÏÇ∞ ÌååÏùº ÏóÖÎ°úÎìú -->
        <section>
            <h2 class="text-lg font-bold mb-2">2. Ï†ïÏÇ∞ ÌååÏùº ÏóÖÎ°úÎìú</h2>
            <div class="ml-6 overflow-x-auto">
                <table
                    class="text-balance min-w-[600px] w-full text-m border border-slate-600 rounded-lg shadow bg-white dark:bg-slate-800"
                >
                    <thead class="bg-amber-100 dark:bg-yellow-900">
                        <tr>
                            <th class="px-3 py-2 border-r border-slate-600">Ïú†ÌÜµÏÇ¨ ÏñëÏãù</th>
                            <th class="px-3 py-2 border-r border-slate-600">ÏñëÏãù Í¥ÄÎ¶¨</th>
                            <th class="px-3 py-2 border-r border-slate-600">ÌååÏùº ÏóÖÎ°úÎìú</th>
                            <th class="px-3 py-2">ÌååÏùº ÏÉÅÌÉú</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(row, idx) in adjustmentStore.uploadRows" :key="row.label">
                            <td class="px-3 py-1 border-r border-slate-600">{{ row.label }}</td>
                            <td class="px-3 py-1 border-r border-slate-600 text-center">
                                <button
                                    class="bg-amber-200 hover:bg-amber-300 text-amber-900 font-medium rounded px-3 py-1 transition-colors whitespace-nowrap"
                                    @click="openNotSupportModal"
                                >
                                    ÏñëÏãù Í¥ÄÎ¶¨
                                </button>
                            </td>
                            <td class="px-3 py-1 border-r border-slate-600 text-center">
                                <label class="inline-flex items-center cursor-pointer">
                                    <input
                                        :key="'file-input-' + fileInputKey[idx]"
                                        type="file"
                                        accept=".xlsx,.xls"
                                        class="hidden"
                                        @change="(e) => onFileChange(e, idx)"
                                    />
                                    <span
                                        class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded px-4 py-1 transition-colors whitespace-nowrap cursor-pointer"
                                        >ÏÑ†ÌÉù</span
                                    >
                                </label>
                                <span class="ml-2 text-xs text-gray-500" v-if="row.fileName">
                                    {{ row.fileName }}
                                </span>
                                <button v-if="row.fileName" class="ml-1" @click="removeFile(idx)">
                                    üóëÔ∏è
                                </button>
                            </td>
                            <td class="px-3 py-1 text-center">
                                <span v-if="row.status === 'None'" class="text-gray-400">
                                    ÎØ∏Ï≤òÎ¶¨
                                </span>
                                <span v-else-if="row.status === 'Parsed'" class="text-emerald-700">
                                    Î∂ÑÏÑù ÏôÑÎ£å
                                </span>
                                <span v-else-if="row.status === 'Parsed-S2'" class="text-blue-600">
                                    Î∂ÑÏÑù Ï§ë..(S2)
                                </span>
                                <span v-else-if="row.status === 'Parsing'" class="text-blue-600">
                                    Ï≤òÎ¶¨ Ï§ë
                                </span>
                                <!-- Error Ìè¨Ìï® Ïãú -->
                                <span v-else-if="row.status === 'Error'" class="text-red-600">
                                    Ïò§Î•ò
                                </span>
                                <span
                                    v-else-if="row.status === 'Error-Parsing'"
                                    class="text-red-600"
                                >
                                    Ïò§Î•ò
                                </span>
                                <span v-else class="text-gray-400">Ïò§Î•ò Í∞í ÌôïÏù∏ ÌïÑÏöî</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Ï†ÅÏû¨ ÌîÑÎ°úÏÑ∏Ïä§ ÌòÑÌô© -->
        <section class="ml-6">
            <div class="flex items-center gap-2 mb-2">
                <h2 class="text-m">ÏÑ∏Î∂Ä Ï†ÅÏû¨ ÌîÑÎ°úÏÑ∏Ïä§</h2>

                <!-- ÏÉàÎ°úÍ≥†Ïπ® Î≤ÑÌäº -->
                <button
                    @click="fetchDetaileTablesLoadStatus"
                    class="text-sm text-blue-600 hover:underline focus:outline-none"
                >
                    üîÑ ÏÉàÎ°úÍ≥†Ïπ®
                </button>
                <button
                    @click="showLoadStatus = !showLoadStatus"
                    class="text-sm text-gray-600 hover:underline focus:outline-none"
                >
                    {{ showLoadStatus ? 'Ïà®Í∏∞Í∏∞ ‚ñ≤' : 'ÌéºÏπòÍ∏∞ ‚ñº' }}
                </button>
            </div>

            <div v-if="showLoadStatus" class="overflow-x-auto">
                <table
                    class="min-w-[800px] w-full text-m border border-slate-600 rounded-lg shadow bg-white dark:bg-slate-800"
                >
                    <thead class="bg-slate-100 dark:bg-slate-900">
                        <tr>
                            <th class="px-3 py-0 border border-slate-600">1</th>
                            <th class="px-3 py-0 border border-slate-600">2</th>
                            <th class="px-3 py-0 border border-slate-600">3</th>
                            <th class="px-3 py-0 border border-slate-600">4</th>
                            <th class="px-3 py-0 border border-slate-600">5</th>
                            <th class="px-3 py-0 border border-slate-600">6</th>
                            <th class="px-3 py-0 border border-slate-600">7</th>
                            <th class="px-3 py-0 border border-slate-600">8</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="text-center">
                            <td
                                v-for="table in loadProcessTables"
                                :key="table.key"
                                class="px-1 text-sm py-1 border border-slate-600"
                            >
                                <span>
                                    {{ table.label }}
                                </span>
                            </td>
                        </tr>

                        <tr class="text-center">
                            <td
                                v-for="(table, idx) in filteredTables"
                                :key="table.key + '-status'"
                                :colspan="idx === 3 || idx === 4 ? 2 : undefined"
                                class="px-0 text-sm py-1 border border-slate-600"
                            >
                                <span v-if="!isTableStatusLoaded">...‚è≥</span>
                                <span
                                    v-else
                                    :class="
                                        tableLoadStatus[table.key]
                                            ? 'text-green-600'
                                            : 'text-gray-400'
                                    "
                                >
                                    {{ tableLoadStatus[table.key] ? 'Ïú†' : 'Î¨¥' }}
                                </span>

                                <!-- Î≤ÑÌäºÎèÑ Î°úÎî©ÎêòÍ∏∞ Ï†ÑÏóêÎäî Ïà®ÍπÄ -->
                                <template v-if="isTableStatusLoaded">
                                    <button
                                        v-if="tableLoadStatus[table.key]"
                                        class="ml-1 text-red-600 hover:underline"
                                        @click="deleteDetailTableData(table.key)"
                                    >
                                        [Del {{ table.step }}]
                                    </button>
                                    <button
                                        v-else-if="table.step > 1"
                                        class="ml-1 text-blue-600 hover:underline"
                                        @click="processDetailTable(table.key)"
                                    >
                                        [Do {{ table.step }}]
                                    </button>
                                </template>
                            </td>
                        </tr>
                        <tr class="text-center"></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- 3. Ïù¥Î©îÏùº ÌôïÏù∏ ÎßàÍ∞êÏùº ÏÑ§Ï†ï -->
        <section>
            <h2 class="text-lg font-bold mb-2">3. Ïù¥Î©îÏùº ÌôïÏù∏ ÎßàÍ∞êÏùº ÏÑ§Ï†ï</h2>
            <div class="flex items-center gap-4">
                <label class="ml-6 font-semibold whitespace-nowrap"> Î©îÏùºÌôïÏù∏ ÎßàÍ∞êÏùº ÏÑ§Ï†ï </label>
                <input
                    type="date"
                    v-model="adjustmentStore.emailDeadline"
                    class="border rounded px-3 py-1 focus:outline-none focus:ring-2 focus:ring-amber-400 bg-white dark:bg-slate-800 text-gray-900 dark:text-white"
                    style="min-width: 160px"
                />
            </div>
        </section>

        <!-- 4. ÌïòÎã® Î≤ÑÌäº -->
        <div class="flex justify-center gap-4 mt-10">
            <button
                class="bg-emerald-700 hover:bg-emerald-800 text-white font-bold px-8 py-2 rounded disabled:bg-gray-300"
                @click="onClickSaveConfirm"
            >
                Ï†ÄÏû•
            </button>
            <BaseButtonA :canClick="adjustmentStore.canCreateSettlement" @click="onGoToBalance">
                Ï†ïÏÇ∞ ÎßåÎì§Í∏∞ : (B)alanceÎ°ú
            </BaseButtonA>
        </div>
    </div>

    <!-- Î™®Îã¨ -->
    <BaseModal
        v-if="showModal"
        :title="modalTitle"
        :message="modalMessage"
        :buttons="modalButtons"
        @background-click="showModal = false"
    />

    <BaseModal
        v-if="showErrorModal"
        :title="errorModalTitle"
        :message="errorModalMsg"
        :buttons="[{ text: 'ÌôïÏù∏', type: 'primary', onClick: () => (showErrorModal = false) }]"
        @close="showErrorModal = false"
        @background-click="showErrorModal = false"
    >
        <template #default>
            <div class="overflow-auto max-h-[400px]">
                <table class="w-full text-sm border-collapse">
                    <thead class="bg-slate-200 dark:bg-slate-700 sticky top-0">
                        <tr>
                            <th class="border border-gray-400 px-3 py-2">No</th>
                            <th
                                v-for="key in tableHeaders"
                                :key="key"
                                class="border border-gray-400 px-3 py-2"
                            >
                                {{ formatHeader(key) }}
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr
                            v-for="(detail, idx) in parsedErrorDetails"
                            :key="idx"
                            class="text-center"
                        >
                            <td class="border border-gray-400 px-3 py-1">{{ idx + 1 }}</td>
                            <td
                                v-for="key in tableHeaders"
                                :key="key"
                                class="border border-gray-400 px-3 py-1"
                            >
                                {{ detail[key] }}
                            </td>
                        </tr>
                        <tr v-if="!parsedErrorDetails.length">
                            <td
                                :colspan="tableHeaders.length + 1"
                                class="text-center border border-gray-400 px-3 py-2"
                            >
                                ÏÉÅÏÑ∏ Ïò§Î•ò Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </template>
    </BaseModal>
</template>

<script setup lang="ts">
import { useSettlementStore } from '@/stores/b_settlement/settlement';
import { useAdjustmentStore } from '@/stores/b_settlement/adjustment';
import BaseModal from '@/components/BaseModal.vue';
import BaseButtonA from '@/components/BaseButtonA.vue';
import { ref, onMounted, computed, watch } from 'vue';
import { TabType } from '@/types/settlement';
import { useToast } from 'vue-toastification';

const settlementStore = useSettlementStore();
const adjustmentStore = useAdjustmentStore();

const props = defineProps<{
    selectedMonth: string;
    selectedMonthId: number;
}>();

// ÏÑúÎ≤Ñ Î∞òÏòÅ ÏÉÅÌÉúÎ•º Î≥ÑÎèÑÏùò refÎ°ú Í¥ÄÎ¶¨
const savedAdjustmentStatus = ref<boolean[]>([false, false, false]);
const showLoadStatus = ref(true);

const fileInputKey = ref([0, 0]); // uploadRowsÏùò Í∞úÏàòÏôÄ ÎèôÏùºÌïú Í∏∏Ïù¥Î°ú Ï¥àÍ∏∞Ìôî

onMounted(async () => {
    if (props.selectedMonth) {
        await onMonthChanged(props.selectedMonth);
    }
});

const emit = defineEmits<{
    (e: 'update-abc-progress', tab: TabType, status: string): void;
    (e: 'update-inside-status', status: { adjustment: boolean[] }): void;
    (e: 'go-balance'): void;
}>();

// ÌïòÎÇòÎùºÎèÑ Ï≤òÎ¶¨ Ï§ëÏù∏ ÌååÏùºÏù¥ ÏûàÎäîÏßÄ ÌôïÏù∏
const isAnyFileProcessing = computed(() => {
    return adjustmentStore.uploadRows.some((row) => ['Parsing'].includes(row.status));
});

const showErrorModal = ref(false);
const errorModalTitle = ref('');
const errorModalMsg = ref('[]');

function openErrorModal(title: string, jsonMsg: string) {
    errorModalTitle.value = title;
    errorModalMsg.value = jsonMsg || '[]';
    showErrorModal.value = true;
}

interface ErrorDetailItem {
    [key: string]: string | number; // key-value ÌòïÏãù Î≤îÏö©
}

const parsedErrorDetails = computed<ErrorDetailItem[]>(() => {
    try {
        const data = JSON.parse(errorModalMsg.value);
        return Array.isArray(data) ? data : [];
    } catch (error) {
        console.error('Ïò§Î•ò Îç∞Ïù¥ÌÑ∞ ÌååÏã± Ï§ë Ïò§Î•ò Î∞úÏÉù:', error);
        return [];
    }
});

const tableHeaders = computed(() => {
    if (!parsedErrorDetails.value.length) return [];
    return Object.keys(parsedErrorDetails.value[0]);
});

// ÏòµÏÖò: Ìó§ÎçîÎ•º Î≥¥Í∏∞ Ï¢ãÍ≤å Î∞îÍøîÏ§å
function formatHeader(key: string) {
    const headersMap: Record<string, string> = {
        album_id: 'Ïï®Î≤î ID',
        album_name: 'Ïï®Î≤îÎ™Ö',
        song_name: 'Í≥°Î™Ö',
        song_id: 'Í≥° ID',
        artist_name: 'ÏïÑÌã∞Ïä§Ìä∏Î™Ö',
        reason: 'Ïò§Î•ò Ïù¥Ïú†',
        user_name: 'ÌöåÏõêÎ™Ö',
        user_id: 'ÌöåÏõê ID',
        bank_info: 'ÏùÄÌñâ Ï†ïÎ≥¥',
        email: 'Ïù¥Î©îÏùº',
        biz_type: 'ÏÇ¨ÏóÖÏûê Ïú†Ìòï',
        settle_rate: 'ÏßÄÎ∂ÑÏú®',
    };
    return headersMap[key] || key;
}

const showModal = ref(false);

const modalTitle = ref('');
const modalMessage = ref('');
const modalButtons = ref<{ text: string; onClick: () => void; type?: 'primary' | 'default' }[]>([]);

function openNotSupportModal() {
    modalTitle.value = 'ÏßÄÏõêÌïòÏßÄ ÏïäÎäî Í∏∞Îä•';
    modalMessage.value = 'ÌòÑÏû¨ Ï†úÍ≥µÌïòÏßÄ ÏïäÎäî Í∏∞Îä•ÏûÖÎãàÎã§. Í¥ÄÎ¶¨ÏûêÏóêÍ≤å Î¨∏ÏùòÌï¥Ï£ºÏÑ∏Ïöî.';
    modalButtons.value = [
        {
            text: 'ÌôïÏù∏',
            type: 'primary',
            onClick: () => {
                showModal.value = false;
            },
        },
    ];
    showModal.value = true;
}

function onFileChange(e: Event, idx: number) {
    const file = (e.target as HTMLInputElement).files?.[0];
    if (file) {
        adjustmentStore.setFile(idx, file);
    }
}

function removeFile(idx: number) {
    if (adjustmentStore.uploadRows[idx]) {
        adjustmentStore.uploadRows[idx].file = null;
        adjustmentStore.uploadRows[idx].fileName = '';
        fileInputKey.value[idx]++;
    }
}

function onClickSaveConfirm() {
    const changedEmail = adjustmentStore.emailDeadline !== adjustmentStore.initialEmailDeadline;
    const uploadedFiles = adjustmentStore.uploadRows.map((row) => row.file?.name || 'ÏóÜÏùå');

    modalTitle.value = 'Ï†ÄÏû• ÌôïÏù∏';
    modalMessage.value = `
   üìÖ Ïù¥Î©îÏùº ÎßàÍ∞êÏùº: ${changedEmail ? 'Î≥ÄÍ≤ΩÎê®' : 'Î≥ÄÍ≤Ω ÏóÜÏùå'}  
   üìÅ ÏóÖÎ°úÎìú ÌååÏùº: Íµ≠ÎÇ¥ - ${uploadedFiles[0]}, Ìï¥Ïô∏ - ${uploadedFiles[1]}

   ÏúÑ ÎÇ¥Ïö©ÏúºÎ°ú Ï†ÄÏû•ÌïòÏãúÍ≤†ÏäµÎãàÍπå?
    `;

    modalButtons.value = [
        { text: 'Ï∑®ÏÜå', type: 'default', onClick: () => (showModal.value = false) },
        { text: 'ÌôïÏù∏', type: 'primary', onClick: onSaveClick },
    ];
    showModal.value = true;
}

async function onSaveClick() {
    showModal.value = false;

    try {
        // 1. ÌòÑÏû¨ ÏóÖÎ°úÎìúÎêú ÌååÏùº ÏÉÅÌÉú ÌôïÏù∏
        const files = adjustmentStore.uploadRows.map((row) => row.file).filter(Boolean); // nullÏù¥ ÏïÑÎãå Í≤ÉÎßå

        // 2. ÌååÏùºÏù¥ 1Í∞úÎßå ÏûàÎäî Í≤ΩÏö∞ ‚Üí ÌóàÏö© Ïïà Ìï®
        if (files.length === 1) {
            modalTitle.value = 'ÏóÖÎ°úÎìú Ïò§Î•ò';
            modalMessage.value = 'ÌååÏùºÏùÄ Î∞òÎìúÏãú 2Í∞úÎ•º Ìï®Íªò ÏóÖÎ°úÎìúÌï¥Ïïº Ìï©ÎãàÎã§.';
            showModal.value = true;
            return;
        }

        // 3. Î≥ÄÍ≤ΩÎêú Í≤ÉÏù¥ ÏóÜÎäî Í≤ΩÏö∞ ‚Üí Ï†ÄÏû• Î∂àÍ∞Ä
        const emailChanged = adjustmentStore.emailDeadline !== adjustmentStore.initialEmailDeadline;
        if (!emailChanged && files.length === 0) {
            modalTitle.value = 'Ï†ÄÏû•Ìï† Î≥ÄÍ≤Ω ÎÇ¥Ïö©Ïù¥ ÏóÜÏäµÎãàÎã§.';
            modalMessage.value = 'Ïù¥Î©îÏùºÏù¥ÎÇò ÌååÏùºÏù¥ Î≥ÄÍ≤ΩÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.';
            showModal.value = true;
            return;
        }

        // 4. Ï†ÄÏû• ÏöîÏ≤≠

        const presign = await adjustmentStore.getPresignedUrls();
        await adjustmentStore.uploadAllFilesToS3(presign);

        modalTitle.value = 'Ï†ÄÏû• ÏôÑÎ£å';
        modalMessage.value = 'Ï†ïÏÉÅÏ†ÅÏúºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.';

        // 5. ÏÑúÎ≤Ñ ÏÉÅÌÉú ÏÉàÎ°ú Ï°∞Ìöå ÌõÑ Ï†ÄÏû•
        // await adjustmentStore.fetchVerificationData();
        // savedAdjustmentStatus.value = [...adjustmentStore.AdjustmentStatus];
        emit('update-inside-status', { adjustment: savedAdjustmentStatus.value });

        // 6. ÏÉÅÏúÑ ÌååÏùºÏóê ÏÉÅÌÉú Ï†ÑÎã¨
        emit('update-abc-progress', 'adjustment', 'inProgress');
        useToast().success('ÏóÖÎ°úÎìú Î∞è Î∂ÑÏÑù ÏöîÏ≤≠ ÏôÑÎ£å');
    } catch (e: unknown) {
        modalTitle.value = 'ÌååÏùº Îì±Î°ù Î∞è Ï†ÄÏû• Ïã§Ìå®';
        modalMessage.value = e instanceof Error ? e.message : 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
    } finally {
        modalButtons.value = [
            { text: 'ÌôïÏù∏', type: 'primary', onClick: () => (showModal.value = false) },
        ];
        showModal.value = true;
    }
}

async function onGoToBalance() {
    if (!adjustmentStore.canCreateSettlement) {
        modalTitle.value = 'Ï†ïÏÇ∞ÏùÑ ÏßÑÌñâÌï† Ïàò ÏóÜÏäµÎãàÎã§';
        modalMessage.value = getSettlementBlockedReasons();
        modalButtons.value = [
            { text: 'ÌôïÏù∏', type: 'primary', onClick: () => (showModal.value = false) },
        ];
        showModal.value = true;
        return;
    }

    await settlementStore.updateMonthStatus(props.selectedMonth, 'Balance');

    emit('update-abc-progress', 'adjustment', 'completed');
    emit('update-abc-progress', 'balance', 'inProgress');
    emit('update-inside-status', { adjustment: [true, true, true] });
    emit('go-balance');
}

function getSettlementBlockedReasons() {
    const reasons = [];

    const precheckOk = adjustmentStore.precheckList.every((i) => i.errorCount === 0);
    if (!precheckOk) reasons.push(' > ÏÇ¨Ï†Ñ Ï†ïÎ≥¥ ÌôïÏù∏ ÌëúÏóê Ïò§Î•òÍ∞Ä ÏûàÏäµÎãàÎã§.\n');

    const filesOk = adjustmentStore.uploadRows.every((row) => row.status === 'Parsed');
    if (!filesOk)
        reasons.push(' > Ï†ïÏÇ∞ ÌååÏùº 2Í∞úÍ∞Ä Î™®Îëê Ï†ïÏÉÅÏ†ÅÏúºÎ°ú Î∂ÑÏÑù ÏôÑÎ£å(Parsed)Í∞Ä ÎêòÏñ¥Ïïº Ìï©ÎãàÎã§.\n');

    if (!adjustmentStore.emailDeadline) reasons.push(' > Î©îÏùº ÎßàÍ∞êÏùºÏù¥ ÏûÖÎ†•ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.\n');

    return reasons.join('');
}

// Ï†ÅÏû¨ ÌîÑÎ°úÏÑ∏Ïä§ ÏÉÅÏÑ∏ Î≥¥Í∏∞ Ìëú ÏòÅÏó≠ Í¥ÄÎ†® Í∏∞Îä•
const isTableStatusLoaded = ref(false);

const loadProcessTables = [
    // 1Îã®Í≥Ñ
    { key: 'settle_files', label: 'settle_files', step: 1 },

    // 2Îã®Í≥Ñ
    { key: 'settle_data', label: 'settle_data', step: 2 },

    // 3Îã®Í≥Ñ
    { key: 'song_settles', label: 'song_settles', step: 3 },

    // 4Îã®Í≥Ñ (5Îã®Í≥ÑÎäî Î≤ÑÌäº ÏóÜÏùå )
    { key: 'album_settles', label: 'album_settles', step: 4 },
    { key: 'b5_album_advances_bespoke', label: 'b5_album_advances (bespok_fee Ï∞®Í∞ê)', step: 5 },

    // 6Îã®Í≥Ñ (7Îã®Í≥ÑÎäî Î≤ÑÌäº ÏóÜÏùå)
    { key: 'b6_user_album_settles', label: 'b6_user_album_settles', step: 6 },
    {
        key: 'b5_album_advances_normal',
        label: 'b5_album_advances (normal_recoup Ï∞®Í∞ê)',
        step: 7,
    },

    // 8Îã®Í≥Ñ
    { key: 'user_settles', label: 'user_settles', step: 8 },
];

// ÌÖåÏù¥Î∏îÎ≥Ñ Ïú†/Î¨¥ ÏÉÅÌÉú
const tableLoadStatus = ref<{ [key: string]: boolean }>({});

const filteredTables = computed(() => loadProcessTables.filter((_, idx) => idx !== 4 && idx !== 6));

let latestRequestId = 0;

// ÌÖåÏù¥Î∏î ÏÉÅÌÉú Î∂àÎü¨Ïò§Í∏∞ API Ìò∏Ï∂ú (ÏòàÏãú: adjustmentStore.fetchDetailTableData_Status)
async function fetchDetaileTablesLoadStatus() {
    const requestId = ++latestRequestId;
    isTableStatusLoaded.value = false;

    try {
        const result = await adjustmentStore.fetchDetailTableData_Status(props.selectedMonthId);

        // ‚úÖ ÏùëÎãµ ÎèÑÏ∞© ÏãúÏ†êÏóê Ïó¨Ï†ÑÌûà ÏµúÏã† ÏöîÏ≤≠Ïù∏ÏßÄ ÌôïÏù∏
        if (requestId !== latestRequestId) {
            console.warn('Ïù¥Ï†Ñ Ïõî ÏùëÎãµ ÎèÑÏ∞©: Î¨¥ÏãúÎê®');
            return;
        }

        tableLoadStatus.value = {};
        result.forEach(({ table, exists }: { table: string; exists: boolean }) => {
            tableLoadStatus.value[table] = exists;
        });
    } catch (e) {
        console.error('ÌÖåÏù¥Î∏î ÏÉÅÌÉú Ï°∞Ìöå Ïã§Ìå®:', e);
    } finally {
        isTableStatusLoaded.value = true; // Î°úÎî© ÏôÑÎ£å
    }
}
// 1,2,3,4,6,8 Îã®Í≥ÑÎßå Ï≤òÎ¶¨ ÎåÄÏÉÅ (index Í∏∞Ï§ÄÏúºÎ°ú 0,1,2,3,5,7)
const processableTables = computed(() => {
    return loadProcessTables.filter((_, idx) => [0, 1, 2, 3, 5, 7].includes(idx));
});

const lastLoadedTableKey = computed(() => {
    const reversed = [...processableTables.value].reverse();
    return reversed.find((t) => tableLoadStatus.value[t.key])?.key || null;
});

const firstNotLoadedTableKey = computed(() => {
    return processableTables.value.find((t) => !tableLoadStatus.value[t.key])?.key || null;
});

// ÏÇ≠Ï†ú ÏöîÏ≤≠
async function deleteDetailTableData(tableKey: string) {
    if (tableKey !== lastLoadedTableKey.value) {
        alert(`[Del] ${tableKey}Îäî ÏÇ≠Ï†úÌï† Ïàò ÏóÜÏäµÎãàÎã§. ÎßàÏßÄÎßâ Îã®Í≥ÑÎßå Í∞ÄÎä•Ìï©ÎãàÎã§.`);
        return;
    }

    // ‚úÖ settle_filesÏùº Í≤ΩÏö∞ Ï∂îÍ∞Ä Í≤ÄÏÇ¨
    if (tableKey === 'settle_files' && isAnyFileProcessing.value) {
        alert('ÌååÏùº Ï≤òÎ¶¨ ÏûëÏóÖÏù¥ ÎÅùÎÇòÍ≥† Í∞ÄÎä•Ìï©ÎãàÎã§.');
        return;
    }

    const confirmed = confirm(`${tableKey}Ïùò Îç∞Ïù¥ÌÑ∞Î•º Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`);
    if (!confirmed) return;

    try {
        await adjustmentStore.deleteDetaileTableData(props.selectedMonthId, tableKey);
        await fetchDetaileTablesLoadStatus();

        // ‚úÖ [Del 8] (user_settles ÏÇ≠Ï†ú) Ïãú ÏÉÅÌÉú Ï†ÑÎã¨
        if (tableKey === 'user_settles') {
            emit('update-abc-progress', 'adjustment', 'inProgress');
        }
    } catch (e) {
        console.error(`${tableKey} ÏÇ≠Ï†ú Ïã§Ìå®:`, e);
    }
}

async function processDetailTable(tableKey: string) {
    if (tableKey !== firstNotLoadedTableKey.value) {
        alert(`[Do] ${tableKey}Îäî Ï†ÅÏû¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§. Í∞ÄÏû• Ïïû Îã®Í≥ÑÎßå Í∞ÄÎä•Ìï©ÎãàÎã§.`);
        return;
    }

    try {
        await adjustmentStore.processTable(props.selectedMonthId, tableKey);
        await fetchDetaileTablesLoadStatus();
    } catch (e) {
        console.error(`Îã®Í≥Ñ Ï†ÅÏû¨ Ïã§Ìå® (${tableKey}):`, e);
    }
}

watch(
    () => props.selectedMonth,
    async (newMonth) => {
        if (newMonth) {
            await onMonthChanged(newMonth);
        }
    }
);

async function onMonthChanged(month: string) {
    await adjustmentStore.fetchVerificationData();

    savedAdjustmentStatus.value = [...adjustmentStore.AdjustmentStatus];
    emit('update-inside-status', { adjustment: savedAdjustmentStatus.value });

    fileInputKey.value = [Date.now(), Date.now() + 1];

    await fetchDetaileTablesLoadStatus();
}
</script>
