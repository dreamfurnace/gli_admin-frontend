name: Deploy Admin Frontend to Staging

on:
  push:
    branches: [stg]
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-2
  NODE_VERSION: '22'

jobs:
  deploy:
    name: Build and Deploy to S3 + CloudFront (Staging)
    runs-on: ubuntu-latest

    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci

    - name: í™˜ê²½ ë³€ìˆ˜ ìƒì„±
      run: |
        export TZ='Asia/Seoul'
        BUILD_UID=$(date '+%m.%d-%H:%M:%S')
        echo "BUILD_UID=$BUILD_UID" >> $GITHUB_ENV
        echo "ğŸ¯ Generated BUILD_UID: $BUILD_UID (KST)"

        # .env.staging íŒŒì¼ì´ ì´ë¯¸ ì¡´ì¬í•˜ë¯€ë¡œ, ë¹Œë“œ UIDë§Œ ì¶”ê°€
        echo "VITE_BUILD_UID=$BUILD_UID" >> .env.staging

        echo "ğŸ“ í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ì—…ë°ì´íŠ¸ ì™„ë£Œ"
        cat .env.staging

    - name: TypeScript íƒ€ì… ì²´í¬
      run: npm run type-check || echo "âš ï¸  íƒ€ì… ì²´í¬ ê²½ê³  ë¬´ì‹œ (ë°°í¬ ì§„í–‰)"

    - name: í”„ë¡œë•ì…˜ ë¹Œë“œ (Staging ëª¨ë“œ)
      run: npm run build-only -- --mode staging
      env:
        NODE_ENV: production

    - name: ë¹Œë“œ ê²°ê³¼ í™•ì¸
      run: |
        echo "ğŸ“¦ ë¹Œë“œ ê²°ê³¼ ë””ë ‰í† ë¦¬ ë‚´ìš©:"
        ls -lah dist/
        echo "ğŸ“Š ë¹Œë“œ íŒŒì¼ í¬ê¸°:"
        du -sh dist/

    - name: AWS ìê²© ì¦ëª… ì„¤ì •
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: S3 ë²„í‚· ë™ê¸°í™”
      run: |
        echo "â˜ï¸  S3 ë²„í‚·ì— ì—…ë¡œë“œ ì¤‘..."
        aws s3 sync ./dist s3://${{ secrets.STG_S3_BUCKET }} \
          --delete \
          --cache-control "public, max-age=31536000, immutable" \
          --exclude "index.html" \
          --exclude "*.map"

        # index.htmlì€ ìºì‹œí•˜ì§€ ì•ŠìŒ
        aws s3 cp ./dist/index.html s3://${{ secrets.STG_S3_BUCKET }}/index.html \
          --cache-control "public, max-age=0, must-revalidate" \
          --content-type "text/html"

        echo "âœ… S3 ì—…ë¡œë“œ ì™„ë£Œ"

    - name: CloudFront SPA ë¼ìš°íŒ… ì„¤ì • í™•ì¸
      run: |
        echo "ğŸ” CloudFront ì—ëŸ¬ í˜ì´ì§€ ì„¤ì • í™•ì¸ ì¤‘..."

        # CloudFront ë°°í¬ ì„¤ì • ê°€ì ¸ì˜¤ê¸°
        ETAG=$(aws cloudfront get-distribution-config \
          --id ${{ secrets.STG_CLOUDFRONT_DISTRIBUTION_ID }} \
          --query 'ETag' \
          --output text)

        echo "í˜„ì¬ ETag: $ETAG"

        # ì—ëŸ¬ í˜ì´ì§€ ì„¤ì •ì´ ì—†ìœ¼ë©´ ì¶”ê°€ (403, 404 â†’ index.html)
        aws cloudfront get-distribution-config \
          --id ${{ secrets.STG_CLOUDFRONT_DISTRIBUTION_ID }} \
          --output json > /tmp/cf-config.json

        # CustomErrorResponses í™•ì¸ ë° ì—…ë°ì´íŠ¸
        python3 << 'PYTHON_SCRIPT'
        import json

        with open('/tmp/cf-config.json', 'r') as f:
            config = json.load(f)

        dist_config = config['DistributionConfig']

        # SPA ë¼ìš°íŒ…ì„ ìœ„í•œ ì—ëŸ¬ ì‘ë‹µ ì„¤ì •
        error_responses = [
            {
                "ErrorCode": 403,
                "ResponsePagePath": "/index.html",
                "ResponseCode": "200",
                "ErrorCachingMinTTL": 10
            },
            {
                "ErrorCode": 404,
                "ResponsePagePath": "/index.html",
                "ResponseCode": "200",
                "ErrorCachingMinTTL": 10
            }
        ]

        # CustomErrorResponses ì—…ë°ì´íŠ¸
        dist_config['CustomErrorResponses'] = {
            'Quantity': len(error_responses),
            'Items': error_responses
        }

        # ì—…ë°ì´íŠ¸ëœ ì„¤ì • ì €ì¥
        with open('/tmp/cf-config-updated.json', 'w') as f:
            json.dump(dist_config, f)

        print("âœ… CloudFront SPA ë¼ìš°íŒ… ì„¤ì • ì¤€ë¹„ ì™„ë£Œ")
        PYTHON_SCRIPT

        # CloudFront ë°°í¬ ì—…ë°ì´íŠ¸
        aws cloudfront update-distribution \
          --id ${{ secrets.STG_CLOUDFRONT_DISTRIBUTION_ID }} \
          --distribution-config file:///tmp/cf-config-updated.json \
          --if-match "$ETAG" || echo "âš ï¸  CloudFront ì„¤ì •ì€ ì´ë¯¸ ìµœì‹  ìƒíƒœì´ê±°ë‚˜ ì—…ë°ì´íŠ¸ê°€ ë¶ˆí•„ìš”í•©ë‹ˆë‹¤"

        echo "âœ… CloudFront SPA ë¼ìš°íŒ… ì„¤ì • ì™„ë£Œ"

    - name: CloudFront ìºì‹œ ë¬´íš¨í™”
      run: |
        echo "ğŸ”„ CloudFront ìºì‹œ ë¬´íš¨í™” ì¤‘..."
        INVALIDATION_ID=$(aws cloudfront create-invalidation \
          --distribution-id ${{ secrets.STG_ADMIN_CF_DISTRIBUTION_ID }} \
          --paths "/*" \
          --query 'Invalidation.Id' \
          --output text)

        echo "ë¬´íš¨í™” ID: $INVALIDATION_ID"
        echo "âœ… CloudFront ìºì‹œ ë¬´íš¨í™” ìš”ì²­ ì™„ë£Œ"

    - name: ë°°í¬ ì™„ë£Œ ì•Œë¦¼
      if: always()
      run: |
        if [ "${{ job.status }}" = "success" ]; then
          echo "ğŸ‰ GLI Admin Frontend Staging ë°°í¬ ì„±ê³µ!"
          echo "ğŸŒ URL: https://stg-admin.glibiz.com"
          echo "ğŸ·ï¸  BUILD_UID: ${{ env.BUILD_UID }}"
          echo "ğŸ“¦ S3 Bucket: ${{ secrets.STG_S3_BUCKET }}"
          echo "â˜ï¸  CloudFront: ${{ secrets.STG_CLOUDFRONT_DISTRIBUTION_ID }}"
        else
          echo "âŒ GLI Admin Frontend Staging ë°°í¬ ì‹¤íŒ¨!"
        fi

    - name: CloudFront SPA ë¼ìš°íŒ… ì„¤ì • í™•ì¸
      run: |
        echo "ğŸ” CloudFront ì—ëŸ¬ í˜ì´ì§€ ì„¤ì • í™•ì¸ ì¤‘..."

        # CloudFront ë°°í¬ ì„¤ì • ê°€ì ¸ì˜¤ê¸°
        ETAG=$(aws cloudfront get-distribution-config \
          --id ${{ secrets.STG_CLOUDFRONT_DISTRIBUTION_ID }} \
          --query 'ETag' \
          --output text)

        echo "í˜„ì¬ ETag: $ETAG"

        # ì—ëŸ¬ í˜ì´ì§€ ì„¤ì •ì´ ì—†ìœ¼ë©´ ì¶”ê°€ (403, 404 â†’ index.html)
        aws cloudfront get-distribution-config \
          --id ${{ secrets.STG_CLOUDFRONT_DISTRIBUTION_ID }} \
          --output json > /tmp/cf-config.json

        # CustomErrorResponses í™•ì¸ ë° ì—…ë°ì´íŠ¸
        python3 << 'PYTHON_SCRIPT'
        import json

        with open('/tmp/cf-config.json', 'r') as f:
            config = json.load(f)

        dist_config = config['DistributionConfig']

        # SPA ë¼ìš°íŒ…ì„ ìœ„í•œ ì—ëŸ¬ ì‘ë‹µ ì„¤ì •
        error_responses = [
            {
                "ErrorCode": 403,
                "ResponsePagePath": "/index.html",
                "ResponseCode": "200",
                "ErrorCachingMinTTL": 10
            },
            {
                "ErrorCode": 404,
                "ResponsePagePath": "/index.html",
                "ResponseCode": "200",
                "ErrorCachingMinTTL": 10
            }
        ]

        # CustomErrorResponses ì—…ë°ì´íŠ¸
        dist_config['CustomErrorResponses'] = {
            'Quantity': len(error_responses),
            'Items': error_responses
        }

        # ì—…ë°ì´íŠ¸ëœ ì„¤ì • ì €ì¥
        with open('/tmp/cf-config-updated.json', 'w') as f:
            json.dump(dist_config, f)

        print("âœ… CloudFront SPA ë¼ìš°íŒ… ì„¤ì • ì¤€ë¹„ ì™„ë£Œ")
        PYTHON_SCRIPT

        # CloudFront ë°°í¬ ì—…ë°ì´íŠ¸
        aws cloudfront update-distribution \
          --id ${{ secrets.STG_CLOUDFRONT_DISTRIBUTION_ID }} \
          --distribution-config file:///tmp/cf-config-updated.json \
          --if-match "$ETAG" || echo "âš ï¸  CloudFront ì„¤ì •ì€ ì´ë¯¸ ìµœì‹  ìƒíƒœì´ê±°ë‚˜ ì—…ë°ì´íŠ¸ê°€ ë¶ˆí•„ìš”í•©ë‹ˆë‹¤"

        echo "âœ… CloudFront SPA ë¼ìš°íŒ… ì„¤ì • ì™„ë£Œ"
